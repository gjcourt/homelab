apiVersion: cilium.io/v2
kind: CiliumClusterwideEnvoyConfig
metadata:
  name: cilium-gateway-authelia-ext-authz-production
  namespace: default
spec:
  services:
    # Associates this CCEC with the production Gateway's Envoy listener.
    # NOTE: The `listener` field is intentionally omitted.
    # In Cilium ≤1.14 (pre-single-listener Gateway API), `listener: https` would
    # match the HTTPS sectionName and correctly inject HTTP filters. In Cilium
    # 1.15+, the Gateway API controller creates a single combined listener (named
    # "listener") for all sectionNames, so there is no `https` listener to match.
    # Setting `listener: listener` or `listener: https` with the current Cilium
    # version results in "cache unmodified by transaction" — Cilium constructs the
    # merged listener but the Gateway API internal listener is not updated.
    # The HTTP filter injection mechanism is currently broken for Cilium 1.18
    # Gateway API listeners regardless of the `listener` field value.
    #
    # TODO: Investigate Cilium GatewayAPI ext-authz once
    #   https://github.com/cilium/cilium/issues/32793 is resolved, or migrate
    #   Navidrome to a native OIDC approach.
    - name: cilium-gateway-app-gateway-production
      namespace: default
  resources:
    - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: authelia_production_service
      connect_timeout: 5s
      type: LOGICAL_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: authelia_production_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: authelia.authelia-prod.svc.cluster.local
                      port_value: 9091
    - "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
      name: envoy.filters.http.ext_authz
      transport_api_version: V3
      status_on_error:
        code: ServiceUnavailable
      failure_mode_allow: false
      http_service:
        server_uri:
          uri: http://authelia.authelia-prod.svc.cluster.local:9091/api/authz/ext-authz
          cluster: authelia_production_service
          timeout: 5s
        authorization_request:
          allowed_headers:
            patterns:
              - exact: cookie
              - exact: user-agent
              - exact: accept
              - exact: referer
              - exact: x-forwarded-proto
              - exact: x-forwarded-host
              - exact: x-forwarded-for
        authorization_response:
          allowed_upstream_headers:
            patterns:
              - exact: remote-user
              - exact: remote-name
              - exact: remote-email
              - exact: remote-groups
          allowed_client_headers:
            patterns:
              # Passes Authelia's Set-Cookie (session cookie) on login redirect
              - exact: set-cookie
              # Passes Authelia's 302 Location header so the browser is
              # redirected to the Authelia login page on unauthenticated requests
              - exact: location
              # Passes WWW-Authenticate on 401 responses
              - exact: www-authenticate
