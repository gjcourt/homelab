apiVersion: batch/v1
kind: CronJob
metadata:
  name: adguard-sync
  namespace: adguard
  labels:
    app.kubernetes.io/name: adguard
spec:
  # Syncs config from adguard-0 (origin) to adguard-1 (replica) every 6 hours.
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      activeDeadlineSeconds: 120
      backoffLimit: 1
      template:
        spec:
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: adguardhome-sync
              image: ghcr.io/bakito/adguardhome-sync:v0.8.2
              args: ["run", "--runOnStart", "--api-port", "0"]
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop: ["ALL"]
                readOnlyRootFilesystem: true
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  memory: 64Mi
              env:
                - name: LOG_LEVEL
                  value: info

                # Origin (primary). Route all UI/admin writes to the primary pod only.
                - name: ORIGIN_URL
                  value: http://adguard-admin:8080

                # Credentials for the origin and replicas.
                # Create these Secrets per-environment when enabling the CronJob.
                - name: ORIGIN_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: adguard-sync-credentials
                      key: ORIGIN_USERNAME
                - name: ORIGIN_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: adguard-sync-credentials
                      key: ORIGIN_PASSWORD

                # Replica 1 (when you scale to 2+ replicas).
                - name: REPLICA1_URL
                  value: http://adguard-1.adguard-headless:80
                - name: REPLICA1_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: adguard-sync-credentials
                      key: REPLICA1_USERNAME
                - name: REPLICA1_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: adguard-sync-credentials
                      key: REPLICA1_PASSWORD

                # Safety defaults: do not sync DHCP (you likely want UniFi handling DHCP).
                - name: FEATURES_DHCP_SERVER_CONFIG
                  value: "false"
                - name: FEATURES_DHCP_STATIC_LEASES
                  value: "false"
