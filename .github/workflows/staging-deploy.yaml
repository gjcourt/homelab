name: Deploy to Staging

# Rebuilds the staging branch by merging master + all passing PRs.
# Triggers:
#   - When PR checks complete (check_suite) — ensures we pick up newly-passing PRs
#   - On PR events — catches new/updated PRs immediately
#   - Every 5 minutes (cron) — safety net to catch anything missed
#   - Manual dispatch — for ad-hoc rebuilds
on:
  check_suite:
    types: [completed]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [master]
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  sync-staging:
    runs-on: ubuntu-latest
    # Only run on check_suite events for PRs targeting master
    if: >-
      github.event_name != 'check_suite' ||
      github.event.check_suite.head_branch != github.event.repository.default_branch
    permissions:
      contents: write
      pull-requests: read
      checks: read
      statuses: read
    steps:
      - name: Checkout Master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Staging Candidate
        run: |
          # Create a fresh branch off master
          git checkout -B staging origin/master

      - name: Merge Passing PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MERGED=0
          SKIPPED=0

          # Get list of open, mergeable PRs targeting master
          PRS=$(gh pr list --state open --base master --json number,mergeable --limit 50 \
            --jq '.[] | select(.mergeable == "MERGEABLE") | .number')

          if [ -z "$PRS" ]; then
            echo "No mergeable PRs found."
          fi

          for PR_NUM in $PRS; do
            echo "::group::PR #$PR_NUM"
            echo "Checking PR #$PR_NUM..."

            # Get check results, excluding this workflow's own check to avoid
            # chicken-and-egg problem where staging-deploy is always "pending"
            CHECKS_JSON=$(gh pr checks "$PR_NUM" --json name,state,bucket 2>/dev/null || echo "[]")

            # Filter out the staging-deploy check itself
            FILTERED=$(echo "$CHECKS_JSON" | jq '[.[] | select(.name != "sync-staging")]')

            CHECKS_COUNT=$(echo "$FILTERED" | jq 'length')
            CHECKS_FAIL=$(echo "$FILTERED" | jq '[.[] | select(.bucket == "fail")] | length')
            CHECKS_PENDING=$(echo "$FILTERED" | jq '[.[] | select(.bucket == "pending")] | length')

            echo "  Checks: total=$CHECKS_COUNT fail=$CHECKS_FAIL pending=$CHECKS_PENDING"

            # Merge if: all checks passed (none failing/pending), OR no checks exist
            # PRs with no checks are safe to preview in staging (they still need
            # PR review before merging to master)
            if [ "$CHECKS_FAIL" -eq 0 ] && [ "$CHECKS_PENDING" -eq 0 ]; then
              echo "  PR #$PR_NUM is ready. Attempting merge into staging..."

              git fetch origin "pull/$PR_NUM/head:pr-$PR_NUM"
              if git merge "pr-$PR_NUM" --no-edit -m "Merge PR #$PR_NUM into staging"; then
                echo "  Successfully merged PR #$PR_NUM"
                MERGED=$((MERGED + 1))
              else
                echo "  Conflict merging PR #$PR_NUM — skipping."
                git merge --abort
                SKIPPED=$((SKIPPED + 1))
              fi
            else
              echo "  PR #$PR_NUM not ready (fail=$CHECKS_FAIL, pending=$CHECKS_PENDING) — skipping."
              SKIPPED=$((SKIPPED + 1))
            fi
            echo "::endgroup::"
          done

          echo "### Staging build summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Merged: $MERGED" >> "$GITHUB_STEP_SUMMARY"
          echo "- Skipped: $SKIPPED" >> "$GITHUB_STEP_SUMMARY"

      - name: Push to Staging
        run: |
          # Force push the new staging state
          git push origin staging --force
