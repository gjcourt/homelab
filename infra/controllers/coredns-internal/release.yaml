apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: coredns-internal
  namespace: flux-system
spec:
  interval: 1h
  targetNamespace: dns-system
  chart:
    spec:
      chart: coredns
      version: "1.39.1"
      sourceRef:
        kind: HelmRepository
        name: coredns
        namespace: flux-system
  install:
    createNamespace: true
  values:
    isClusterService: false
    serviceType: LoadBalancer
    # Pin this IP via MetalLB/Cilium L2 pool so AdGuard can forward to it reliably
    # You must assign an available IP from your single-node-pool here
    # Example: 192.168.4.120 (Update this with a free IP)
    service:
      loadBalancerIP: 192.168.5.50
      annotations:
        service.cilium.io/global: "true"

    servers:
      - zones:
          - zone: stage.burntbytes.com
        port: 53
        plugins:
          - name: log
          - name: errors
          - name: health
            config:
              lameduck: 5s
          - name: ready
          - name: etcd
            config: |
              path /skydns
              endpoint http://etcd-headless:2379
          - name: cache
            parameters: 30
          - name: prometheus
            parameters: 0.0.0.0:9153

    # We need a small etcd instance for CoreDNS to store records via ExternalDNS
    extraContainers:
      - name: etcd
        image: quay.io/coreos/etcd:v3.6.7
        env:
          - name: ETCD_LISTEN_CLIENT_URLS
            value: http://0.0.0.0:2379
          - name: ETCD_ADVERTISE_CLIENT_URLS
            value: http://etcd-headless:2379
        ports:
          - containerPort: 2379
            name: client

    # Headless service for etcd communication within the pod
    # (Since we run etcd as a sidecar for simplicity in this single-replica authoritative setup)
    extraManifests:
      - apiVersion: v1
        kind: Service
        metadata:
          name: etcd-headless
          namespace: dns-system
        spec:
          clusterIP: None
          selector:
            app.kubernetes.io/instance: coredns-internal
            app.kubernetes.io/name: coredns
          ports:
            - port: 2379
              name: client
